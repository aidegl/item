# 明道云接口&数据字典文档

## 文档概述

本文档详细描述了明道云接口的调用规范、数据字典定义、错误处理机制及最佳实践，旨在确保项目中明道云接口调用的统一性和规范性。

## 接口组件说明

### 组件引用方式（通用）

项目中使用以下相对路径引用组件，以适配服务器部署结构：

```html
<!-- 复用组件：用户数据获取 -->
<script src="/project/components/MingdaoQuery.js"></script>
<script src="/project/components/MingdaoAdd.js"></script>
<script src="/project/components/MingdaoUpdate.js"></script>
<script src="/project/components/MingdaoArray.js"></script>
```

> **注意**：
> 1. 服务器根目录为 `/www/wwwroot/100000whys.cn/`。
> 2. 组件文件位于 `/www/wwwroot/100000whys.cn/components/`。
> 3. 使用绝对路径 `/components/` 可确保在任何层级的页面中都能正确引用。

### 组件列表

| 组件名称 | 对应接口 | 功能描述 |
|---------|---------|---------|
| MingDaoYunAPI | getRowByIdPost | 单条数据查询 |
| MingDaoYunAddAPI | addRow | 新增数据 |
| MingDaoYunUpdateAPI | editRow | 更新数据 |
| MingDaoYunArrayAPI | getFilterRows | 批量查询数据 |

### MingDaoYunAPI（单条数据查询）

#### 接口信息
- **接口地址**：https://api.mingdao.com/v2/open/worksheet/getRowByIdPost
- **请求方法**：POST
- **功能**：根据行ID查询单条数据

#### 调用方法
```javascript
const api = new window.MingDaoYunAPI();
const result = await api.getData(rowid, worksheetId);
```

#### 参数说明
| 参数名 | 类型 | 说明 | 必填 |
|-------|------|------|------|
| rowid | String | 行ID | 是 |
| worksheetId | String | 工作表ID | 是 |

#### 返回格式
```javascript
{
  "success": true,    // 是否成功
  "data": Object,    // 查询到的数据
  "error_msg": "",   // 错误信息
  "error_code": 1    // 错误代码
}
```

### MingDaoYunAddAPI（新增数据）

#### 接口信息
- **接口地址**：https://api.mingdao.com/v2/open/worksheet/addRow
- **请求方法**：POST
- **功能**：向工作表中新增数据

#### 调用方法
```javascript
const api = new window.MingDaoYunAddAPI();
const result = await api.getData(worksheetId, controls);
```

#### 参数说明
| 参数名 | 类型 | 说明 | 必填 |
|-------|------|------|------|
| worksheetId | String | 工作表ID | 是 |
| controls | Array | 新增字段数组 | 是 |

#### controls参数格式
```javascript
[
  {
    "id": "字段ID",
    "value": "字段值"
  }
]
```

#### 返回格式
```javascript
{
  "success": true,    // 是否成功
  "data": Object,    // 新增后的数据
  "error_msg": "",   // 错误信息
  "error_code": 1    // 错误代码
}
```

### MingDaoYunUpdateAPI（更新数据）

#### 接口信息
- **接口地址**：https://api.mingdao.com/v2/open/worksheet/editRow
- **请求方法**：POST
- **功能**：更新工作表中的数据

#### 调用方法
```javascript
const api = new window.MingDaoYunUpdateAPI();
const result = await api.getData(rowid, worksheetId, controls);
```

#### 参数说明
| 参数名 | 类型 | 说明 | 必填 |
|-------|------|------|------|
| rowid | String | 行ID | 是 |
| worksheetId | String | 工作表ID | 是 |
| controls | Array | 更新字段数组 | 是 |

#### controls参数格式
```javascript
[
  {
    "controlId": "字段ID",
    "value": "字段值"
  }
]
```

#### 返回格式
```javascript
{
  "success": true,    // 是否成功
  "data": Object,    // 更新后的数据
  "error_msg": "",   // 错误信息
  "error_code": 1    // 错误代码
}
```

### MingDaoYunArrayAPI（批量查询数据）

#### 接口信息
- **接口地址**：https://api.mingdao.com/v2/open/worksheet/getFilterRows
- **请求方法**：POST
- **功能**：根据过滤条件批量查询数据

#### 调用方法
```javascript
const api = new window.MingDaoYunArrayAPI();
const result = await api.getData(params);
```

#### 参数说明
| 参数名 | 类型 | 默认值 | 说明 | 必填 |
|-------|------|-------|------|------|
| worksheetId | String | - | 工作表ID | 是 |
| viewId | String | "" | 视图ID | 否 |
| pageSize | Number | 50 | 每页条数 | 否 |
| pageIndex | Number | 1 | 页码 | 否 |
| keyWords | String | "" | 关键词 | 否 |
| listType | Number | 0 | 列表类型 | 否 |
| controls | String/Array | "" | 查询字段 | 否 |
| **filters** | String/Array | [] | **过滤条件（必须为数组格式）** | 否 |
| sortId | String | "" | 排序字段ID | 否 |
| isAsc | String | "false" | 是否升序 | 否 |
| notGetTotal | String | "false" | 是否不获取总数 | 否 |
| useControlId | String | "false" | 是否使用controlId | 否 |
| getSystemControl | String | "false" | 是否获取系统字段 | 否 |

#### filters参数格式（强制要求）
```javascript
[
  {
    "controlId": "openid",
    "dataType": 2,
    "spliceType": 1,
    "filterType": 24,
    "value": "openid"
  },
  {
    "controlId": "del",
    "dataType": 2,
    "spliceType": 1,
    "filterType": 2,
    "value": 0
  }
]
```

#### 返回格式
```javascript
{
  "success": true,    // 是否成功
  "data": {
    "rows": Array,    // 数据列表
    "total": Number   // 总条数
  },
  "error_msg": "",   // 错误信息
  "error_code": 1    // 错误代码
}
```

## 数据字典

### 通用字段定义

#### del字段（逻辑删除标识）
- **controlId**: "del"
- **dataType**: 2
- **含义**: 逻辑删除标识
- **取值**: 
  - 0: 未删除
  - 1: 已删除
- **使用要求**: 所有查询接口必须包含此过滤条件，默认查询未删除数据

#### openid字段
- **controlId**: "openid"
- **dataType**: 2
- **含义**: 用户唯一标识
- **取值**: 微信用户openid

#### 筛选器单条件参数提交示例

{
"controlId":"ordernumber"
"dataType":6
"spliceType":1
"filterType":13
"value":"2"
}

#### 筛选器层级条件参数提交示例

[ {"controlId": "leixing","dataType": 2, "spliceType": 1,"filterType": 2,"value": "订单"},{"isGroup": true,"spliceType": 1,     "groupFilters": [{"controlId": "faqiren", "dataType": 2, "spliceType": 2,"filterType": 24,"value": "ff074b4e-92ad-466e-9018-d3a7d150e8ee"},{"controlId": "jieshouren","dataType": 2,"spliceType": 2,"filterType": 24,"value": "ff074b4e-92ad-466e-9018-d3a7d150e8ee"}]}]

### 核心枚举值说明

#### DataTypeEnum（控件类型枚举）

| 枚举值   | 控件类型   | 说明               |
| ----- | ------ | ---------------- |
| 2     | 文本     | 单行文本、多行文本        |
| 3     | 电话     | 手机号              |
| 4     | 电话     | 座机号              |
| 5     | 邮箱     | 邮箱地址             |
| 6     | 数值     | 纯数字（不含小数）        |
| 7     | 证件     | 身份证、护照等证件号       |
| 8     | 金额     | 带小数的金额（支持货币单位）   |
| 9     | 单选     | 平铺式单选            |
| 10    | 多选     | 多选框              |
| 11    | 单选     | 下拉式单选            |
| 14    | 附件     | 上传文件、图片等         |
| 15    | 日期     | 格式：年 - 月 - 日     |
| 16    | 日期     | 格式：年 - 月 - 日 时：分 |
| 21    | 自由连接   | 自定义链接            |
| 22    | 分段     | 分段显示字段           |
| 24    | 地区     | 省 - 市 - 区三级联动    |
| 25    | 大写金额   | 金额的中文大写形式        |
| 26    | 成员     | 明道云组织成员选择        |
| 27    | 部门     | 明道云组织部门选择        |
| 28    | 等级     | 自定义等级字段          |
| 29    | 关联记录   | 关联其他数据表的记录       |
| 30    | 他表字段   | 引用其他数据表的字段值      |
| 31    | 公式     | 计算结果为数字          |
| 32    | 文本组合   | 多字段拼接的文本         |
| 33    | 自动编号   | 系统自动生成的唯一编号      |
| 34    | 子表     | 数据表内嵌子表          |
| 35    | 级联选择   | 多级联动选择（如品类 - 规格） |
| 36    | 检查框    | 布尔值选择（是 / 否）     |
| 37    | 汇总     | 子表数据汇总（求和、计数等）   |
| 38    | 公式     | 计算结果为日期          |
| 40    | 定位     | 地理位置（经纬度）        |
| 41    | 富文本    | 带格式的文本（图片、表格等）   |
| 42    | 签名     | 手写签名             |
| 45    | 嵌入     | 嵌入第三方页面、表单       |
| 46    | 时间     | 格式：时：分（不含日期）     |
| 47    | 条码     | 二维码、条形码          |
| 48    | 组织角色   | 明道云组织角色选择        |
| 49    | API 查询 | 通过 API 获取的字段值    |
| 50    | API 查询 | 多结果 API 查询字段     |
| 51    | 查询记录   | 关联查询其他数据表的记录     |
| 10010 | 备注     | 长文本备注字段          |

#### FilterTypeEnum（筛选类型枚举）

| 枚举值 | 枚举字符         | 说明         | 适用场景           |
| --- | ------------ | ---------- | -------------- |
| 0   | Default      | 默认筛选       | 通用场景           |
| 1   | Like         | 包含         | 文本、数值、邮箱等模糊匹配  |
| 2   | Eq           | 是（等于）      | 所有类型的精确匹配      |
| 3   | Start        | 开头为        | 文本、自动编号等前缀匹配   |
| 4   | End          | 结尾为        | 文本、自动编号等后缀匹配   |
| 5   | NContain     | 不包含        | 文本、数值等排除匹配     |
| 6   | Ne           | 不是（不等于）    | 所有类型的排除精确匹配    |
| 7   | IsNull       | 为空         | 所有类型的空值筛选      |
| 8   | HasValue     | 不为空        | 所有类型的非空值筛选     |
| 11  | Between      | 在范围内       | 数值、金额等连续值范围筛选  |
| 12  | NBetween     | 不在范围内      | 数值、金额等连续值排除筛选  |
| 13  | Gt           | >（大于）      | 数值、日期、金额等比较筛选  |
| 14  | Gte          | >=（大于等于）   | 数值、日期、金额等比较筛选  |
| 15  | Lt           |            | 数值、日期、金额等比较筛选  |
| 16  | Lte          | （小于等于）     | 数值、日期、金额等比较筛选  |
| 17  | DateEnum     | 日期是        | 日期类型的固定日期筛选    |
| 18  | NDateEnum    | 日期不是       | 日期类型的排除固定日期筛选  |
| 21  | MySelf       | 我拥有的       | 成员关联字段的归属筛选    |
| 22  | UnRead       | 未读         | 消息、通知类字段筛选     |
| 23  | Sub          | 下属         | 成员字段的下属关系筛选    |
| 24  | RCEq         | 关联控件是      | 关联记录字段的精确匹配    |
| 25  | RCNe         | 关联控件不是     | 关联记录字段的排除匹配    |
| 26  | ArrEq        | 数组等于       | 多选、级联选择等数组类型匹配 |
| 27  | ArrNe        | 数组不等于      | 多选、级联选择等数组类型排除 |
| 31  | DateBetween  | 在范围内（日期）   | 日期类型的范围筛选      |
| 32  | DateNBetween | 不在范围内（日期）  | 日期类型的范围排除筛选    |
| 33  | DateGt       | >（日期大于）    | 日期类型的比较筛选      |
| 34  | DateGte      | >=（日期大于等于） | 日期类型的比较筛选      |
| 35  | DateLt       | 日期小于）      | 日期类型的比较筛选      |
| 36  | DateLte      | ）          | 日期类型的比较筛选      |
| 41  | NormalUser   | 常规用户       | 成员字段的用户类型筛选    |
| 42  | PortalUser   | 外部门户用户     | 成员字段的外部用户筛选    |

#### DateRangeEnum（日期范围枚举）

| 枚举值 | 枚举字符        | 说明                            |
| --- | ----------- | ----------------------------- |
| 0   | Default     | 默认范围                          |
| 1   | Today       | 今天                            |
| 2   | Yesterday   | 昨天                            |
| 3   | Tomorrow    | 明天                            |
| 4   | ThisWeek    | 本周                            |
| 5   | LastWeek    | 上周                            |
| 6   | NextWeek    | 下周                            |
| 7   | ThisMonth   | 本月                            |
| 8   | LastMonth   | 上月                            |
| 9   | NextMonth   | 下月                            |
| 10  | LastEnum    | 上 N 个单位（配合 dateRangeType）     |
| 11  | NextEnum    | 下 N 个单位（配合 dateRangeType）     |
| 12  | ThisQuarter | 本季度                           |
| 13  | LastQuarter | 上季度                           |
| 14  | NextQuarter | 下季度                           |
| 15  | ThisYear    | 本年                            |
| 16  | LastYear    | 去年                            |
| 17  | NextYear    | 明年                            |
| 18  | Customize   | 自定义日期范围（需传 minValue/maxValue） |
| 21  | Last7Day    | 过去 7 天                        |
| 22  | Last14Day   | 过去 14 天                       |
| 23  | Last30Day   | 过去 30 天                       |
| 31  | Next7Day    | 未来 7 天                        |
| 32  | Next14Day   | 未来 14 天                       |
| 33  | Next33Day   | 未来 33 天                       |

### 示例数据结构

#### 用户表数据结构
```javascript
{
  "rowId": "row_123456",
  "openid": "oJZJz1xpX5ftzwXZhP31nKYIGeYM",
  "name": "张三",
  "phone": "13800138000",
  "del": 0,
  "createTime": "2025-12-29 10:00:00",
  "updateTime": "2025-12-29 10:00:00"
}
```

## 错误处理机制

### 错误代码定义

| 错误代码 | 说明 |
|---------|------|
| 1 | 成功 |
| 10101 | 明道云接口调用失败 |
| 99999 | 网络/解析错误 |

### 错误处理示例

```javascript
const api = new window.MingDaoYunArrayAPI();
try {
  const result = await api.getData(params);
  if (result.success) {
    // 处理成功逻辑
    console.log('查询成功:', result.data);
  } else {
    // 处理失败逻辑
    console.error('查询失败:', result.error_msg, '错误代码:', result.error_code);
    // 展示友好错误信息给用户
    alert('查询数据失败：' + result.error_msg);
  }
} catch (error) {
  // 处理异常情况
  console.error('调用异常:', error);
  alert('网络异常，请稍后重试');
}
```

## 最佳实践

### 性能优化
- 合理设置pageSize，避免一次性查询过多数据
- 使用viewId过滤视图，减少返回字段
- 必要时设置notGetTotal为"true"，提高查询速度

### 安全规范
- 不要在前端代码中直接暴露appKey和sign
- 所有接口调用必须通过组件封装进行
- 敏感数据必须进行加密处理

### 代码规范
- 使用async/await处理异步调用
- 必须对返回结果进行错误判断
- 添加适当的日志记录便于调试

### 调用示例

#### 批量查询用户数据
```javascript
// 创建组件实例
const api = new window.MingDaoYunArrayAPI();

// 构造过滤条件（必须为数组格式）
const filters = [
  {
    "controlId": "openid",
    "dataType": 2,
    "spliceType": 1,
    "filterType": 2,
    "value": "oJZJz1xpX5ftzwXZhP31nKYIGeYM"
  },
  {
    "controlId": "del",
    "dataType": 2,
    "spliceType": 1,
    "filterType": 2,
    "value": 0
  }
];

// 调用接口
try {
  const result = await api.getData({
    worksheetId: 'yonghu',
    filters: filters,
    pageSize: 10,
    pageIndex: 1
  });
  
  if (result.success) {
    console.log('查询成功，共', result.data.total, '条数据');
    console.log('数据列表:', result.data.rows);
  } else {
    console.error('查询失败:', result.error_msg);
  }
} catch (error) {
  console.error('调用异常:', error);
}
```

## 注意事项

1. **filters参数必须严格使用数组格式**，不得使用其他数据结构
2. **所有查询操作必须包含del字段过滤条件**，默认值为0（未删除）
3. **物理删除必须在明道云平台进行**，前端系统仅支持逻辑删除
4. **组件修改必须遵循项目规则**，无明确功能问题时不得修改
5. **接口调用具有5秒超时机制**，超时后会自动重试1次

## 版本信息

- **文档版本**: 1.0
- **生效日期**: 2025-12-29
- **更新记录**:
  - 2025-12-29: 初始版本创建
