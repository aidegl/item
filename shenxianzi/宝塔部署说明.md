# 宝塔部署说明 & 小程序接入指南（v2.0）

## 核心目标
1. **Web端**：部署 H5 页面到 `https://100000whys.cn/shenxianzi/webview/`，包含底部导航、个人中心、明道云数据获取。
2. **小程序端**：接入微信小程序，实现 Webview 嵌套及登录/退出跳转。

---

## 第一部分：宝塔服务器部署（H5部分）

### 1. 准备文件
请确保本地已有以下文件结构（我会帮你生成好）：
```
d:\Item\shenxianzi\webview\dist\
├── index.html          # 主入口文件
└── assets\             # 图标资源文件夹
    ├── agent0.png
    ├── agent1.png
    ├── ... (共8个图标)
```

### 2. 上传文件到服务器
1. 登录宝塔面板 -> **文件**。
2. 进入目录：`/www/wwwroot/shenxianzi/webview/dist/`。
   - 如果目录不存在，请手动创建（注意层级：先建 `shenxianzi`，再建 `webview`，再建 `dist`）。
3. **上传操作**：
   - 将本地 `index.html` 上传到该目录。
   - 将本地 `assets` 文件夹及其内容上传到该目录（最终路径应为 `/www/wwwroot/shenxianzi/webview/dist/assets/agent0.png`）。
4. **权限设置**（重要）：
   - 选中 `shenxianzi` 文件夹，点击“权限”，设置为 `755`，所有者 `www`。

### 3. Nginx 配置（关键）
1. 宝塔 -> **网站** -> 点击 `100000whys.cn` -> **配置文件**。
2. 找到 `server { ... }` 块，确保添加了以下配置（如果之前加过，请检查路径是否一致）：
```nginx
# 关键配置：映射 URL 路径到服务器文件目录
location ^~ /shenxianzi/webview/ {
    alias /www/wwwroot/shenxianzi/webview/dist/;
    index index.html;
    # 解决 assets 资源可能的 404 问题
    try_files $uri $uri/ /shenxianzi/webview/index.html;
}
```
3. 保存并**重载配置**。

### 4. 验证 H5
1. 手机或浏览器访问：`https://100000whys.cn/shenxianzi/webview/`
2. 预期效果：
   - 看到底部有4个导航栏（智能体、患者库、备忘录、设置）。
   - 点击图标可以切换高亮状态。
   - 点击“设置”->“立即登录”，会提示“请在微信小程序中打开”（在浏览器中是正常的）。

---

## 第二部分：微信小程序接入

### 1. 准备代码
本地目录：`d:\Item\shenxianzi\wxAPP\`
包含：
- `app.json`
- `pages/webview/` (承载 H5)
- `pages/login/` (原生登录页)
- `pages/logout/` (原生退出页)

### 2. 导入微信开发者工具
1. 打开“微信开发者工具”。
2. 选择“导入项目”或“打开项目”。
3. 目录选择：`d:\Item\shenxianzi\wxAPP`。
4. AppID：使用你自己的小程序 AppID。

### 3. 配置小程序后台（必须）
1. 登录 [微信公众平台](https://mp.weixin.qq.com)。
2. **开发** -> **开发管理** -> **开发设置** -> **业务域名**。
3. 添加：`100000whys.cn`。
   - 注意：需要下载校验文件并上传到服务器根目录（`/www/wwwroot/100000whys.cn/`），否则无法保存。
   - 如果之前配置过，确保 H5 能访问即可。

### 4. 预览调试
1. 在开发者工具中，编译项目。
2. 首页应显示 H5 页面。
3. 点击底部“设置” -> “立即登录”。
4. 此时应跳转到小程序的原生“请确认登录”页面。
5. 点击“确认登录”，模拟登录成功后返回 H5。

---

## 第三部分：小程序上传与发布（新手必读）

### 1. 登录流程优化说明（v2.0新增）
本项目采用了 **Hash路由模式** 传递登录状态，优势如下：
- **无感登录**：小程序登录成功后，通过 `#openid=xxx` 传递参数，Webview 页面不会发生整页刷新，仅触发 HashChange 事件。
- **状态同步**：支持 Webview 内部监听 Hash 变化，实时更新用户状态（头像、昵称）。
- **兼容性**：完美适配 iOS/Android 的 Webview 容器及桌面端调试。

### 2. 上传代码
1. 在 **微信开发者工具** 右上角，找到【上传】按钮（通常在【预览】按钮旁边）。
2. 点击【上传】，填写版本信息：
   - **版本号**：首次填写 `1.0.0`，后续更新递增（如 `1.0.1`）。
   - **项目备注**：填写更新内容，例如“初始化项目，接入Webview”。
3. 点击确定，等待上传成功提示。

### 2. 提交审核
1. 登录 [微信公众平台](https://mp.weixin.qq.com)（使用小程序账号登录）。
2. 左侧菜单栏 -> **管理** -> **版本管理**。
3. 在页面最下方的 **开发版本** 列表中，你会看到刚刚上传的版本（时间应为几分钟前）。
4. 点击右侧的【提交审核】按钮。
5. 按提示填写信息：
   - **功能页面**：选择首页（默认即可）。
   - **标题**：填写小程序名称。
   - **类目**：选择符合你业务的类目（如：工具 > 备忘录）。
6. 提交后，状态会变为“审核中”。审核通常需要 1小时 ~ 1天。

### 3. 正式发布
1. 当你收到微信通知“审核通过”后。
2. 再次登录 [微信公众平台](https://mp.weixin.qq.com) -> **版本管理**。
3. 在 **审核版本** 列表中，找到通过的版本，点击右侧的【发布】按钮。
4. 确认发布后，你的小程序就正式上线了！用户可以通过搜索名称找到它。

### 4. 体验版（可选）
如果你想在审核前给朋友测试：
1. 在 **版本管理** -> **开发版本** 中。
2. 点击右侧下拉箭头 -> **选为体验版**。
3. 获取体验版二维码，发给朋友（朋友需要先被你添加到“成员管理”中作为体验者）。

---

## 第四部分：明道云接口说明
- **API URL**: `https://api.mingdao.com/v2/open/worksheet/getRowByIdPost`
- **调用方式**: 页面加载时自动调用（POST请求）。
- **参数**:
  - `appKey`: `59c7bdc2cdf74e5e`
  - `sign`: (已内置)
  - `worksheetId`: `global_data`
  - `rowId`: `9e5a5ed8-258b-4f20-a5c0-a1d9b9a97c2f`
- **查看结果**:
  - 切换到“智能体”页面。
  - 页面下方灰色区域会显示 API 返回的原始数据（调试用）。
